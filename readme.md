# API สำหรับระบบขนส่ง (POST)

พัฒนาโดย POSTWAY

API นี้ถูกออกแบบมาเพื่อรองรับการเชื่อมต่อ Application ภายนอกที่ต้องการใช้งานระบบขนส่งของ POSTWAY สามารถจัดการข้อมูล สร้างรายการ และรับการแจ้งเตือนเมื่อมีการเปลี่ยนแปลงสถานะ

API ของ POSTWAY เน้นความปลอดภัย ความรวดเร็ว และความถูกต้องในการสื่อสารระหว่างระบบ

# สารบัญ

- [API Document](apidoc.md)
- [Enum, Model & View model](model.md)

# เข้าใจระบบก่อน

ระบบของ POST เป็นระบบรวมขนส่งที่เน้นให้ลูกค้าสร้างรายการส่งของหรือพัสดุ โดยจะมีผู้รับ ผู้ส่ง ข้อมูลประเทศไทย และขนส่งให้บริการ และกระบวนการที่ต้องเข้าใจ ได้แก่ กระบวนการสร้างรายการ ใบปะหน้า

## กระบวนการสร้างรายการ

การสร้างรายการประกอบขั้นตอนการสร้าง ได้แก่

| ลำดับ | หัวข้อ                 | รายละเอียด                                                                                                   |
| --- | -------------------- | ----------------------------------------------------------------------------------------------------------- |
| 1   | การตรวจสอบข้อมูล       | เป็นการตรวจสอบข้อมูล ได้แก่ กฎของขนส่ง ข้อมูลประเทศไทย คำนวณราคาทุน COD และประกัน                                      |
| 2   | สร้างรายการบนระบบ     | สร้างรายการขนส่งบนระบบ Postway ปรับสถานะเป็น Pending                                                            |
| 3   | สร้างรายการบนระบบขนส่ง | สร้างรายการขนส่งบนระบบขนส่งที่ให้บริการ ได้ข้อมูล `tracking_no` ของขนส่งปลายทางเป็น `ref1` สถานะเป็น `WaitingForDropOff` |
| 4   | สร้างใบเสร็จ           | สร้างใบเสร็จ หลักฐานการทำรายการ เวลาต่างๆ ข้อมูลที่คีย์เข้ามาครั้งแรกในระบบ                                               |

ทั้งหมด คือ กระบวนการในการทำรายการสร้างรายการ หากขั้นตอนใดผิดพลาด ก็จะไม่ทำงานต่อไป

![flow chart การสร้างรายการขนส่งกับ POST กับ POSTWAY](<flow-chats/Platform-Flow - Create order shipment.drawio.png>)

เมื่อการสร้างรายการสำเร็จ ระบบจะตอบกลับข้อมูลขนส่ง โดยทาง POSTWAY จะให้บริการเป็น `tracking_no` ของ POSTWAY เอง และเมื่อการสร้างรายการกับ Shipment provider ได้ เราจะมี `REF` ส่งมาด้วย เพื่อให้ลูกค้าสามารถตรวจสอบกับขนส่งนั้นๆ ได้ด้วย

## สถานะรายการขนส่ง

| ชื่อ             | คำอธิบาย             | ตัวอย่าง                                            |
| -------------- | ------------------ | ------------------------------------------------- |
| Prepared       | เตรียมพร้อม          | รายการถูกสร้าง แต่ยังไม่เลือกคนส่ง                       |
| WaitForDropOff | พร้อมส่งกับขนส่ง       | รายการถูกสร้าง เลือกขนส่ง และได้เลข Reference          |
| In-Transit     | อยู่ระหว่างขนส่ง       | รายการถูกสร้าง เลือกขนส่ง และขนส่งรับไปแล้ว อยู่ระหว่างขนส่ง |
| Cancel         | ยกเลิก              | รายการถูกยกเลิก ไม่สามารถยกเลิกได้ถ้า In-Transit ไปแล้ว  |
| Complete       | สำเร็จ               | รายการถูกจัดส่งสำเร็จ                                  |
| Reject         | ยกเลิก ส่งกลับ        | รายการถูกตีกลับ บางขนส่งจะสร้าง Reference เพ่ิมอีก        |
| Claim          | เสียหาย สูยหาย มีปัญหา | รายการขนส่งมีปัญหา อาจสุญหาย                          |

## ภาพสถานะรายการขนส่งที่เป็นไปได้

![Flow chart รายการขนส่งที่วิ่งไปได้](<flow-chats/Platform-FLow - Order shipment status.drawio.png>)

หลังจากที่ลูกค้าทำการส่งพัสดุกับขนส่งดังกล่าวเรียยร้อยแล้วนั้น เราจะให้ลูกค้าสามารถตามข้อมูลดังกล่าวต่อไปได้ โดยการใช้งาน คือ `webhook` โดยทางฝั่งของ POSTWAY จะส่ง HTTP Request ไปทาง URL Webhook ที่ทำการ Register ไว้กับ POSTWAY

สถานการณ์ที่ POSTWAY จะส่ง `HTTP Request` (Webhook) ไป ได้แก่

| หัวข้อ                  | รายละเอียด                                      |
| --------------------- | ---------------------------------------------- |
| สถานะ (Status)        | สถานะมีการปรับเปลี่ยนจากขนส่ง                       |
| น้ำหนักหรือมิติ (Dimension) | น้ำหนัก กว้าง ยาว สูง จากขนส่งที่ให้บริการแจ้งเปลี่ยนแปลงมา |
| ราคา (Price)          | ราคา ทุน รวมถึง COD ที่มีการเปลี่ยนแปลงจากจนส่ง        |

เพื่อความปลอดภัยในการยิง HTTP Request ฝั่ง Application ที่มาเชื่อมต่อต้องรองรับ `HTTPS` และ `Certification` ที่ได้รับการยืนยันความปลอดภัยโดย CA Server ที่ให้บริการเท่านั้น

# ข้อมูลที่เกี่ยวข้อง

ข้อมูลสำคัญๆ ที่มีอยู่ในระบบ POSTWAY ได้แก่

| หัวข้อ              | รายละเอียด                                                                                                                  |
| ----------------- | -------------------------------------------------------------------------------------------------------------------------- |
| Thailand          | ข้อมูลประเทศไทย                                                                                                              |
| Store             | ร้านค้า                                                                                                                      |
| Shipment Provider | ขนส่ง                                                                                                                       |
| Order             | รายการ ประกอบด้วย ข้อมูลผู้รับ (Sender) ผู้ส่ง (Recipient) แพคเกจ (Package) ขาดไม่ได้เลย คือ เลขอ้างอืงประกอบด้วย `tracking_no` หรือ `ref` |
| Receipt           | ใบเสร็จ                                                                                                                     |
| Label             | ใบปะหน้า                                                                                                                    |

# การทำงานของ APIs

## ข้อจำกัด

| ชื่อ              | รายละเอียด                               |
| --------------- | --------------------------------------- |
| Limite Rate     | 100 Requests ต่อนาที ต่อ `access token` ** |
| HTTP Timeout    | 10 นาที ***                              |
| Webhook timeout | 10 วินาที                                 |

** API สร้างรายการยิงได้ไม่จำกัด

*** ตามหลัก ยังไม่มี API ไหนจะทำงานได้เกิน 10 นาที ยกเว้น Report แต่เนื่องด้วยเราทำเป็น Background processing

## การสมัครเพื่อรับ Access Token มาเพื่อยิง API

คุณต้อง Login เข้ามาระบบของ POST โดยที่คุณจะต้องเป็นเจ้าของร้าน และเลือกเมนูดังนี้

เลือกร้าน -> ตั้งค่า -> ร้านค้า -> Merchant APIs -> SESSION

จะได้ `Access Token` มาเพื่อเชื่อมต่อ APIs

# อ้างอิง (Reference)

- https://www.planttext.com/
- https://base64.guru/converter/decode/file